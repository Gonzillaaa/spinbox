#!/bin/bash
# Pre-push hook for Python projects
# Runs full test suite and type checking

set -e

echo "Running pre-push checks for Python project..."

# Check if we're in a Python project
if [[ ! -f "requirements.txt" ]] && [[ ! -f "pyproject.toml" ]]; then
    echo "Warning: No Python project files found"
    exit 0
fi

# Activate virtual environment if available
if [[ -f "venv/bin/activate" ]]; then
    source venv/bin/activate
elif [[ -f ".venv/bin/activate" ]]; then
    source .venv/bin/activate
fi

# Run full test suite
if command -v pytest >/dev/null 2>&1; then
    echo "Running full test suite..."
    if ! pytest --tb=short; then
        echo "❌ Test suite failed"
        exit 1
    fi
    echo "✅ Test suite passed"
else
    echo "Warning: pytest not found, skipping tests"
fi

# Run type checking if mypy is available
if command -v mypy >/dev/null 2>&1; then
    echo "Running type checking..."
    if ! mypy . --ignore-missing-imports; then
        echo "❌ Type checking failed"
        exit 1
    fi
    echo "✅ Type checking passed"
else
    echo "Info: mypy not found, skipping type checking"
fi

# Run security check if bandit is available
if command -v bandit >/dev/null 2>&1; then
    echo "Running security check..."
    if ! bandit -r . -f json -o /dev/null; then
        echo "❌ Security check failed"
        exit 1
    fi
    echo "✅ Security check passed"
else
    echo "Info: bandit not found, skipping security check"
fi

echo "✅ Pre-push checks passed"
exit 0