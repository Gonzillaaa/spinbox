#!/bin/bash
# Pre-push hook for Next.js projects
# Runs full test suite and build validation

set -e

echo "Running pre-push checks for Next.js project..."

# Check if we're in a Next.js project
if [[ ! -f "package.json" ]] || ! grep -q "next" package.json 2>/dev/null; then
    echo "Warning: No Next.js project detected"
    exit 0
fi

# Check if we're in the nextjs directory
if [[ -d "nextjs" ]]; then
    cd nextjs
fi

# Check if npm is available
if ! command -v npm >/dev/null 2>&1; then
    echo "Warning: npm not found, skipping Next.js checks"
    exit 0
fi

# Check if node_modules exists
if [[ ! -d "node_modules" ]]; then
    echo "Warning: node_modules not found, run 'npm install' first"
    exit 0
fi

# Run full test suite
if npm run test >/dev/null 2>&1; then
    echo "Running full test suite..."
    if ! npm run test; then
        echo "❌ Test suite failed"
        exit 1
    fi
    echo "✅ Test suite passed"
else
    echo "Warning: No test script found in package.json"
fi

# Run full Next.js build
if command -v npx >/dev/null 2>&1; then
    echo "Running Next.js full build..."
    if ! npx next build; then
        echo "❌ Next.js build failed"
        exit 1
    fi
    echo "✅ Next.js build passed"
else
    echo "Warning: npx not found, skipping build check"
fi

# Run TypeScript type checking
if [[ -f "tsconfig.json" ]] && command -v npx >/dev/null 2>&1; then
    echo "Running TypeScript type checking..."
    if ! npx tsc --noEmit; then
        echo "❌ TypeScript type checking failed"
        exit 1
    fi
    echo "✅ TypeScript type checking passed"
fi

# Run security audit
if command -v npm >/dev/null 2>&1; then
    echo "Running npm security audit..."
    if ! npm audit --audit-level=moderate; then
        echo "❌ Security audit failed"
        exit 1
    fi
    echo "✅ Security audit passed"
fi

# Run lint check
if npm run lint >/dev/null 2>&1; then
    echo "Running lint check..."
    if ! npm run lint; then
        echo "❌ Lint check failed"
        exit 1
    fi
    echo "✅ Lint check passed"
fi

# Check if the app starts without errors
if command -v npx >/dev/null 2>&1; then
    echo "Testing Next.js app startup..."
    if ! timeout 10s npx next start -p 3001 2>/dev/null &
    then
        echo "⚠️  Next.js app startup test timed out (continuing anyway)"
    else
        # Kill the test server
        pkill -f "next start" 2>/dev/null || true
        echo "✅ Next.js app startup test passed"
    fi
fi

echo "✅ Pre-push checks passed"
exit 0