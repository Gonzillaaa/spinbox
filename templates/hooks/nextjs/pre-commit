#!/bin/bash
# Pre-commit hook for Next.js projects
# Runs ESLint, TypeScript checks, and Prettier formatting

set -e

echo "Running pre-commit checks for Next.js project..."

# Check if we're in a Next.js project
if [[ ! -f "package.json" ]] || ! grep -q "next" package.json 2>/dev/null; then
    echo "Warning: No Next.js project detected"
    exit 0
fi

# Get list of JS/TS files to check
js_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E "\.(js|ts|jsx|tsx)$" || true)

if [[ -z "$js_files" ]]; then
    echo "No JavaScript/TypeScript files to check"
    exit 0
fi

echo "Checking files: $js_files"

# Check if we're in the nextjs directory
if [[ -d "nextjs" ]]; then
    cd nextjs
fi

# Check if npm is available
if ! command -v npm >/dev/null 2>&1; then
    echo "Warning: npm not found, skipping Next.js checks"
    exit 0
fi

# Check if node_modules exists
if [[ ! -d "node_modules" ]]; then
    echo "Warning: node_modules not found, run 'npm install' first"
    exit 0
fi

# Run Next.js lint
if npm run lint >/dev/null 2>&1; then
    echo "Running Next.js lint check..."
    if ! npm run lint; then
        echo "❌ Next.js lint check failed"
        exit 1
    fi
    echo "✅ Next.js lint check passed"
else
    echo "Warning: No lint script found in package.json"
fi

# Run Prettier check
if command -v npx >/dev/null 2>&1; then
    echo "Running Prettier formatting check..."
    if ! npx prettier --check $js_files; then
        echo "❌ Prettier formatting check failed"
        echo "Fix with: npx prettier --write $js_files"
        exit 1
    fi
    echo "✅ Prettier formatting check passed"
else
    echo "Warning: npx not found, skipping Prettier check"
fi

# Run TypeScript check
if [[ -f "tsconfig.json" ]] && command -v npx >/dev/null 2>&1; then
    echo "Running TypeScript check..."
    if ! npx tsc --noEmit; then
        echo "❌ TypeScript check failed"
        exit 1
    fi
    echo "✅ TypeScript check passed"
fi

# Quick Next.js build check (pages only)
if command -v npx >/dev/null 2>&1; then
    echo "Running Next.js build check..."
    if ! timeout 10s npx next build --no-lint 2>/dev/null; then
        echo "⚠️  Next.js build check timed out or failed (continuing anyway)"
    else
        echo "✅ Next.js build check passed"
    fi
fi

echo "✅ Pre-commit checks passed"
exit 0